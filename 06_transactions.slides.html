<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Transactions</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/solarized.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />


  <script type="text/javascript">
      setTimeout(() => { 
        fetch("https://raw.githubusercontent.com/Alex-Octocorn/logo/main/style.js") 
          .then(script => script.text())
          .then((script) => {
            const head = document.querySelector("head");
            const customCss = document.createElement("script");
            customCss.type = "text/javascript";
            customCss.appendChild(document.createTextNode(script));
            head.appendChild(customCss);
          });
      });
    </script></head>
  <body>
    <div class="reveal">
      <div class="slides"><section ><section data-markdown><script type="text/template">

# SQL : Transactions

![SQL](./assets/sql.png) <!-- .element width="30%" align="left" -->

![MySQL](./assets/mysql.png) <!-- .element width="30%" align="right" -->
</script></section><section data-markdown><script type="text/template">
## Transactions

### Définition

- Une transaction est une suite d'opérations qui doit être exécutée dans son intégralité ou pas du tout.

- L'idée étant de tout annuler si une des étapes échoue.
</script></section><section data-markdown><script type="text/template">
## Transactions

### Exemple

Si je veux réaliser un virement bancaire, il faut :
1. Vérifier que j'ai assez d'argent sur mon compte
2. Débiter mon compte
3. Créditer le compte du bénéficiaire

> Que se passerait-il en cas de coupure de courant entre l'étape 2 et 3 ?
</script></section><section data-markdown><script type="text/template">
## Transactions

### Exemple

- Je serais débité mais le bénéficiaire ne serait pas crédité.

> Où est l'argent ?!
</script></section><section data-markdown><script type="text/template">
## Transactions

### Solution

- Les transactions sont là pour résoudre ce genre de problèmes

- On va réaliser les trois étapes sans les valider

- Si tout se passe bien, on valide la transaction

- Sinon, on annule toutes les opérations
</script></section><section data-markdown><script type="text/template">
## Transactions

### En image

![Transaction](assets/transaction.png)
</script></section><section data-markdown><script type="text/template">
## Transactions

### Les commits

- Comme pour Git, un `COMMIT` valide les opérations

- Sur un script SQL, il commit automatiquement à la fin du script

```mysql
-- Désactiver les autocommits
SET AUTOCOMMIT = 0;
```

> Les données sont tout de même présentes dans la base de données, mais elles ne sont pas validées
</script></section><section data-markdown><script type="text/template">
## Transactions

### Les Rollbacks

- `ROLLBACK` annule les opérations qui n'ont pas été commités

- On peut rollback une transaction en cours

- On peut rollback un script SQL

```mysql
-- Annuler les opérations
ROLLBACK;
```
</script></section><section data-markdown><script type="text/template">
## Transactions

### Petit test

Ajoutons un article dans la table `eleves`: 

```mysql
INSERT INTO eleves (nom, prenom, date_naissance)
VALUES ('Devos', 'Alexandre', '1992-07-20')
```

Vérifions :

```mysql
SELECT * FROM eleves;
ROLLBACK;
SELECT * FROM eleves;
```
</script></section><section data-markdown><script type="text/template">
## Transactions

### ROLLBACK

- Finalement, un rollback est un `ctrl + z` sur la base de données.

- Il remet la BDD tel qu'elle était eu dernier commit !

> Quel serait la commande Git équivalente ?

<aside class="notes"><p><code>git stash</code></p>
</aside></script></section><section data-markdown><script type="text/template">
## Transactions

### Essayons de valider

```mysql
INSERT INTO eleves (nom, prenom, date_naissance)
VALUES ('Devos', 'Alexandre', '1992-07-20');
COMMIT;
ROLLBACK;
```
</script></section><section data-markdown><script type="text/template">
## Avant de passer à la suite

Pensez à réactiver les autocommits :

```mysql
SET AUTOCOMMIT = 1;
```
</script></section></section><section ><section data-markdown><script type="text/template">
## Transactions

### Les transactions en SQL

- Plutôt que de désactiver les autocommits, on peut utiliser les transactions

- Cela évite d'oublier de les réactiver !

- On termine une transaction avec `COMMIT` ou `ROLLBACK`

```mysql
START TRANSACTION;
-- Requêtes
COMMIT;
```
</script></section><section data-markdown><script type="text/template">
## Transactions

### Les savepoints

- On peut créer des points de sauvegarde dans une transaction

- On peut revenir à un savepoint avec `ROLLBACK TO`

```mysql
START TRANSACTION;
-- Requêtes
SAVEPOINT savepoint1;
-- Requêtes
SAVEPOINT savepoint2;
-- Requêtes
ROLLBACK TO savepoint1;
-- Requêtes
COMMIT;
```
</script></section><section data-markdown><script type="text/template">
## Transactions

### Validations implicites

Certains éléments valident automatiquement une transaction :
- `CREATE TABLE`, `DROP TABLE`, 
- `CREATE INDEX`, `DROP INDEX`, 
- `ALTER TABLE`, `RENAME TABLE`, 
- `TRUNCATE TABLE`, `LOCK TABLES`, `UNLOCK TABLES`

> Globalement, tout ce qui influe sur la structure de la base de données !
</script></section><section data-markdown><script type="text/template">
## Transactions

### Validations implicites

- Il n'est pas possible de créer une transaction dans une transaction

- En réalité `START TRANSACTION` commite la transaction en cours avant d'en créer une nouvelle !
</script></section></section><section  data-markdown><script type="text/template">
## Retour à l'index

[Index](index.html)</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        slideNumber: true,
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>

    <script src="./_assets/theme.js"></script>

    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
